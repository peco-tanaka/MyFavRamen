# MyFavらぁめん 設計書

## 1. 画面遷移図（作成済み）
*作成済み資料参照*

## 2. DB設計

## 1. usersテーブル
ユーザー情報を管理するテーブル

| column           | type    | options                   |
| ---------------- | ------- | ------------------------- |
| id               | integer | null: false, primary key  |
| nickname         | string  | null: false               |
| email            | string  | null: false, unique: true |
| encrypted_password | string  | null: false               |
| prefecture_id    | integer |                           |
| avatar           | string  |                           |
| favorite_type    | string  |                           |
| created_at       | datetime | null: false              |
| updated_at       | datetime | null: false              |

### association
- has_many :rankings
- has_many :ranking_items, through: :rankings
- has_many :favs
- has_many :fav_shops, through: :favs, source: :shop
- has_many :records
- has_many :active_follows, class_name: "Follow", foreign_key: "follower_id"
- has_many :passive_follows, class_name: "Follow", foreign_key: "followed_id"
- has_many :following, through: :active_follows, source: :followed
- has_many :followers, through: :passive_follows, source: :follower
- belongs_to_active_hash :prefecture

## 2. shopsテーブル
ラーメン店舗情報を管理するテーブル

| column           | type    | options                  |
| ---------------- | ------- | ------------------------ |
| id               | integer | null: false, primary key |
| name             | string  | null: false              |
| address          | string  | null: false              |
| latitude         | float   |                          |
| longitude        | float   |                          |
| business_hours   | string  |                          |
| phone            | string  |                          |
| website          | string  |                          |
| created_at       | datetime | null: false             |
| updated_at       | datetime | null: false             |

### association
- has_many :ranking_items
- has_many :rankings, through: :ranking_items
- has_many :favs
- has_many :users_who_fav, through: :favs, source: :user
- has_many :records

## 3. rankingsテーブル
ユーザーごとの各ジャンルのランキングを管理するテーブル

| column           | type    | options                                |
| ---------------- | ------- | -------------------------------------- |
| id               | integer | null: false, primary key               |
| user_id          | integer | null: false, foreign_key: true         |
| genre_id         | integer | null: false                            |
| created_at       | datetime | null: false                           |
| updated_at       | datetime | null: false                           |

### association
- belongs_to :user
- belongs_to_active_hash :genre
- has_many :ranking_items
- has_many :shops, through: :ranking_items

## 4. ranking_itemsテーブル
ランキング内の各店舗の順位情報を管理するテーブル

| column           | type    | options                                |
| ---------------- | ------- | -------------------------------------- |
| id               | integer | null: false, primary key               |
| ranking_id       | integer | null: false, foreign_key: true         |
| shop_id          | integer | null: false, foreign_key: true         |
| position         | integer | null: false                            |
| comment          | text    |                                        |
| photo            | string  |                                        |
| menu_name        | string  | null: false                            |
| created_at       | datetime | null: false                           |
| updated_at       | datetime | null: false                           |

### association
- belongs_to :ranking
- belongs_to :shop

*photoカラムの画像はActive_storageで管理

## 5. favsテーブル
ユーザーのお気に入り店舗を管理する中間テーブル

| column           | type    | options                                |
| ---------------- | ------- | -------------------------------------- |
| id               | integer | null: false, primary key               |
| user_id          | integer | null: false, foreign_key: true         |
| shop_id          | integer | null: false, foreign_key: true         |
| created_at       | datetime | null: false                           |
| updated_at       | datetime | null: false                           |

### association
- belongs_to :user
- belongs_to :shop

## 6. recordsテーブル
ユーザーのラーメン食べた記録を管理するテーブル

| column           | type    | options                                |
| ---------------- | ------- | -------------------------------------- |
| id               | integer | null: false, primary key               |
| user_id          | integer | null: false, foreign_key: true         |
| shop_id          | integer | null: false, foreign_key: true         |
| menu_name        | string  | null: false                            |
| visited_at       | date    | null: false                            |
| comment          | text    |                                        |
| photo            | string  |                                        |
| created_at       | datetime | null: false                           |
| updated_at       | datetime | null: false                           |

### association
- belongs_to :user
- belongs_to :shop

## 7. followsテーブル
ユーザー間のフォロー関係を管理する中間テーブル

| column           | type    | options                                |
| ---------------- | ------- | -------------------------------------- |
| id               | integer | null: false, primary key               |
| follower_id      | integer | null: false, foreign_key: {to_table: :users} |
| followed_id      | integer | null: false, foreign_key: {to_table: :users} |
| created_at       | datetime | null: false                           |
| updated_at       | datetime | null: false                           |

### association
- belongs_to :follower, class_name: "User"
- belongs_to :followed, class_name: "User"

## 3. URLルーティング設計

| URL パス | コントローラ#アクション | 説明 |
|------------|--------------------------|------|
| / | home#index | トップページ |
| /users/sign_up | devise/registrations#new | 会員登録画面 |
| /users/sign_in | devise/sessions#new | ログイン画面 |
| /my_ranking | rankings#index | 自分のランキング一覧画面 |
| /my_ranking/:genre_id | rankings#show | ジャンル別ランキング画面 |
| /my_ranking/:genre_id/edit | rankings#edit | ランキング編集画面 |
| /profile | users#show | プロフィール画面 |
| /profile/edit | users#edit | プロフィール編集画面 |
| /favs | favs#index | お気に入り店舗リスト画面 |
| /follows | follows#index | フォロー・フォロワー一覧画面 |
| /users/:id | users#show | 他ユーザープロフィール画面 |
| /users/:id/rankings/:genre_id | public_rankings#show | 他ユーザーのランキング表示 |
| /search | shops#search | 店舗検索画面 |
| /shops/:id | shops#show | 店舗詳細画面 |
| /records | records#index | 訪問記録一覧画面 |
| /records/new | records#new | 訪問記録登録画面 |

### API ルーティング (Rails内部APIとして実装)

| URL パス | メソッド | コントローラ#アクション | 説明 |
|------------|----------|--------------------------|------|
| /api/rankings/:id/items | GET | api/ranking_items#index | ランキングアイテム一覧取得 |
| /api/rankings/:id/items | POST | api/ranking_items#create | ランキングアイテム追加 |
| /api/rankings/:id/items/:item_id | PATCH | api/ranking_items#update | ランキングアイテム更新 |
| /api/rankings/:id/items/:item_id | DELETE | api/ranking_items#destroy | ランキングアイテム削除 |
| /api/rankings/:id/sort | PATCH | api/rankings#sort | ランキング順序変更 |
| /api/shops/search | GET | api/shops#search | 店舗検索API |

## 4. API設計

### Google Maps API 連携
目的：店舗の位置情報取得、表示、検索

```javascript
// 店舗検索例
function searchShops(keyword) {
  const request = {
    query: keyword + ' ラーメン',
    fields: ['name', 'geometry', 'formatted_address', 'place_id']
  };
  
  service = new google.maps.places.PlacesService(map);
  service.textSearch(request, handleSearchResults);
}

// 店舗詳細取得例
function getShopDetails(placeId) {
  const request = {
    placeId: placeId,
    fields: ['name', 'formatted_address', 'formatted_phone_number', 
             'opening_hours', 'website', 'geometry']
  };
  
  service.getDetails(request, handleDetailsResult);
}
```

## 5. セキュリティ

### 認証・認可
- Devise gemを使用したユーザー認証
- ストロングパラメータによる入力値検証
- ログイン状態に基づくアクセス制御

### CSRF対策
- Rails標準のCSRF対策を使用
- JavaScript APIリクエストにCSRFトークンを含める

### 個人情報保護
- ランキングの公開/非公開設定
- プロフィール情報の表示範囲制御
- パスワードのハッシュ化保存

### 画像セキュリティ
- Active Storageによる画像アップロード管理
- 画像サイズ制限と形式チェック
- S3への安全な保存

## 6. 使用技術

### 言語・フレームワーク
- Ruby 3.2.2
- Ruby on Rails 7.0.8
- HTML5 / CSS3
- JavaScript (ES6)

### データベース
- PostgreSQL 14.x

### フロントエンド
- Bootstrap 5.3
- SortableJS (ドラッグ&ドロップ機能)
- Stimulus.js (Railsと連携したJavaScript)

### 外部サービス
- Google Maps API
- AWS S3 (画像ストレージ)

### インフラ
- Render (初期デプロイ)
- Docker / Docker Compose (開発環境)

### Gem一覧
```ruby
# Gemfile
gem 'rails', '~> 7.0.8'
gem 'pg', '~> 1.5'
gem 'puma', '~> 6.4'
gem 'jsbundling-rails', '~> 1.2'
gem 'turbo-rails', '~> 1.5'
gem 'stimulus-rails', '~> 1.3'
gem 'cssbundling-rails', '~> 1.3'
gem 'jbuilder', '~> 2.11'
gem 'bootsnap', '~> 1.17', require: false
gem 'image_processing', '~> 1.12'

# 認証
gem 'devise', '~> 4.9'

# 外部API連携
gem 'faraday', '~> 2.8'
gem 'googleauth', '~> 1.8'

# 画像アップロード
gem 'aws-sdk-s3', '~> 1.136', require: false

# ページネーション
gem 'kaminari', '~> 1.2'

# 検索
gem 'ransack', '~> 4.1'

# 日本語化
gem 'rails-i18n', '~> 7.0'
gem 'devise-i18n', '~> 1.12'

# ActiveHash (都道府県や固定データの管理)
gem 'active_hash', '~> 3.2'

group :development, :test do
  gem 'debug', '~> 1.9', platforms: %i[mri mingw x64_mingw]
  gem 'factory_bot_rails', '~> 6.2'
  gem 'rspec-rails', '~> 6.1'
  gem 'faker', '~> 3.2'
end

group :development do
  gem 'web-console', '~> 4.2'
  gem 'rubocop', '~> 1.59', require: false
  gem 'rubocop-rails', '~> 2.23', require: false
  gem 'letter_opener_web', '~> 2.0'
end

group :test do
  gem 'capybara', '~> 3.39'
  gem 'selenium-webdriver', '~> 4.17'
end
```

### Docker設定

```dockerfile
# Dockerfile
FROM ruby:3.2.2-slim

RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential libpq-dev nodejs npm postgresql-client && \
    npm install -g yarn && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY Gemfile Gemfile.lock ./
RUN bundle install
COPY . .

CMD ["bin/rails", "server", "-b", "0.0.0.0"]
```

```yaml
# docker-compose.yml
version: '3'
services:
  db:
    image: postgres:14
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_USER: myfavramen
      POSTGRES_DB: myfavramen_development
    ports:
      - "5432:5432"

  web:
    build: .
    command: bash -c "rm -f tmp/pids/server.pid && bin/dev"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    ports:
      - "3000:3000"
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://myfavramen:password@db:5432/myfavramen_development
      RAILS_ENV: development

volumes:
  postgres_data:
  node_modules:
```

## 7. 開発スケジュール

### Week 1: 基本設計と環境構築（3/25〜3/31）
- 要件定義の確定
- 画面設計・DB設計
- 開発環境構築（Docker, GitHub）
- Rails プロジェクト初期設定
- Devise によるユーザー認証機能実装
- 基本レイアウト作成（BootstrapとSASS）

### Week 2: コア機能の実装（4/1〜4/7）
- Google Maps API連携の基本実装
- 店舗検索・登録機能実装
- ランキング基本機能（CRUD）実装
- ドラッグ＆ドロップによる順位変更機能
- プロフィール機能実装

### Week 3: UI/UX開発と追加機能実装（4/8〜4/14）
- モバイル対応レスポンシブデザイン最適化
- 訪問記録機能実装
- 画像アップロード機能の最適化
- フォロー機能実装
- お気に入り店舗機能実装

### Week 4: テスト、バグ修正、初期デプロイ（4/15〜4/21）
- 単体テスト・結合テスト作成
- エラーハンドリング強化
- パフォーマンス最適化
- デプロイ準備（本番環境設定）
- Renderへの初期デプロイ
- 初期ユーザーテスト
